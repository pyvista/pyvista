name: Build Documentation
on: [pull_request, workflow_dispatch]

jobs:
  doc:
    name: Build Documentation
    runs-on: ubuntu-latest
    env:
      PYVISTA_OFF_SCREEN: 'True'
      ALLOW_PLOTTING: true
      SHELLOPTS: 'errexit:pipefail'
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      - name: Install OSMesa VTK
        run: |
          sudo apt-get install libosmesa6-dev libgl1-mesa-dev
          pip install https://github.com/pyvista/pyvista-wheels/raw/add_v9_1_0/vtk-osmesa-9.1.0-cp38-cp38-linux_x86_64.whl
      - name: Install PyVista
        run: pip install -e .
      - name: Install Dependencies and PyVista
        run: |
          sudo apt-get install python3-tk pandoc
          pip install -r requirements_docs.txt
      - name: PyVista Report
        run: python -c "import pyvista;print(pyvista.Report())"
      - name: Build Documentation
        run: make -C doc html SPHINXOPTS="-w build_errors.txt -N"
      - name: Check for Warnings
        run: python doc/print_errors.py
      - uses: actions/upload-artifact@v2
        with:
          name: docs-build
          path: doc/_build/
      - uses: actions/upload-artifact@v2
        with:
          name: examples
          path: doc/examples/
      - name: Get Notebooks
        run: |
          mkdir _notebooks
          cp doc/examples/**/*.ipynb _notebooks/
      - uses: actions/upload-artifact@v2
        with:
          name: pyvista-notebooks
          path: _notebooks
  deploy:
    name: Publish Documentation
    runs-on: ubuntu-latest
    needs: doc
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: docs-build
          path: html
      - name: Deploy on main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: pyvista/pyvista-docs-dev
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: html
      - name: Deploy on release
        if: startsWith(github.ref, 'refs/tags')
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: pyvista/pyvista-docs
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: html
